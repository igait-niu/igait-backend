version: '3.8'

# iGait Microservices - Queue-based Architecture
# All services are independent workers polling Firebase RTDB queues

x-common-env: &common-env
  # AWS S3 Storage
  AWS_S3_BUCKET: ${AWS_S3_BUCKET:-igait-storage}
  AWS_REGION: ${AWS_REGION:-us-east-2}
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
  # Firebase RTDB (for queues)
  FIREBASE_RTDB_URL: ${FIREBASE_RTDB_URL:-https://network-technology-project-default-rtdb.firebaseio.com}
  FIREBASE_ACCESS_KEY: ${FIREBASE_ACCESS_KEY}
  RUST_LOG: info

services:
  # Frontend Web Application
  web:
    build:
      context: ./igait-web
      dockerfile: Dockerfile
    ports:
      - "80:80"
    depends_on:
      - backend

  # Backend API (handles uploads, pushes to queue 1)
  backend:
    build:
      context: .
      dockerfile: igait-backend/Dockerfile
    ports:
      - "3000:3000"
    environment:
      <<: *common-env
      GOOGLE_APPLICATION_CREDENTIALS: /app/credentials/gcp-key.json
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_ASSISTANT_ID: ${OPENAI_ASSISTANT_ID}
      OPENAI_VECTOR_STORE_ID: ${OPENAI_VECTOR_STORE_ID}
      PORT: 3000
    volumes:
      - ./credentials:/app/credentials:ro

  # Stage 1: Media Conversion Worker
  stage1:
    build:
      context: .
      dockerfile: igait-stages/igait-stage1-media-conversion/Dockerfile
    environment:
      <<: *common-env

  # Stage 2: Validity Check Worker
  stage2:
    build:
      context: .
      dockerfile: igait-stages/igait-stage2-validity-check/Dockerfile
    environment:
      <<: *common-env

  # Stage 3: Reframing Worker
  stage3:
    build:
      context: .
      dockerfile: igait-stages/igait-stage3-reframing/Dockerfile
    environment:
      <<: *common-env

  # Stage 4: Pose Estimation Worker
  stage4:
    build:
      context: .
      dockerfile: igait-stages/igait-stage4-pose-estimation/Dockerfile
    environment:
      <<: *common-env

  # Stage 5: Cycle Detection Worker
  stage5:
    build:
      context: .
      dockerfile: igait-stages/igait-stage5-cycle-detection/Dockerfile
    environment:
      <<: *common-env

  # Stage 6: Prediction Worker
  stage6:
    build:
      context: .
      dockerfile: igait-stages/igait-stage6-prediction/Dockerfile
    environment:
      <<: *common-env

  # Stage 7: Finalize Worker (sends emails)
  stage7:
    build:
      context: .
      dockerfile: igait-stages/igait-stage7-finalize/Dockerfile
    environment:
      <<: *common-env
